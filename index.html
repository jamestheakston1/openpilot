
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenPilot - Create GitHub Issues Instantly</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'gh-primary': '#24292f',
                        'gh-blue': '#0969da',
                        'gh-bg': '#f6f8fa',
                        'gh-dark': '#1f2328',
                        'gh-success': '#2da44e',
                        'gh-warning': '#f0b047',
                        'gh-open': '#2da44e',
                        'gh-closed': '#8250df',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            background-color: theme('colors.gh-bg');
            font-family: theme('fontFamily.sans');
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .issue-card {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            background-color: #ffffff;
            transition: box-shadow 0.15s ease-in-out;
            cursor: pointer;
        }
        .issue-card:hover {
            box-shadow: 0 1px 4px rgba(27, 31, 35, 0.1);
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-6 sm:p-10 mt-8">
        
        <header class="mb-6">
            <div class="flex items-center justify-center space-x-2 text-gh-primary">
                <i data-feather="github" class="w-8 h-8 text-gh-dark"></i>
                <h1 class="text-3xl font-extrabold tracking-tight">OpenPilot</h1>
            </div>
        </header>

        <div id="notification-box" class="hidden p-3 mb-6 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

        <div id="auth-area" class="flex flex-col justify-center items-center space-y-3 mb-6 p-4 border rounded-lg bg-gh-bg">
            <div id="user-profile" class="hidden items-center space-x-3">
                <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User Avatar" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=User'">
                <span id="user-name" class="font-semibold text-gh-dark"></span>

                <div id="kebab-menu" class="relative ml-3 sm:ml-4">
                    <button id="kebab-button" class="p-1 rounded-full hover:bg-gray-200 transition duration-150" aria-label="Account options">
                        <i data-feather="more-vertical" class="w-5 h-5 text-gray-500"></i>
                    </button>

                    <div id="dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl z-20 hidden origin-top-right">
                        <button id="delete-account-button"
                                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center space-x-2 transition duration-150">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                            <span>Delete Account</span>
                        </button>
                    </div>
                </div>
            </div>
            <button id="auth-button"
                    class="w-full sm:w-auto flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                <i data-feather="github" class="w-5 h-5"></i>
                <span id="auth-button-text">Connect with GitHub</span>
            </button>
            
            <a id="help-link" href="/docs#linking" 
               class="flex items-center space-x-1 text-sm text-gray-500 hover:text-gh-blue transition duration-150">
                <i data-feather="external-link" class="w-4 h-4"></i>
                <span>Trouble linking? Click here for help</span>
            </a>
        </div>
        
        <div id="tab-navigation-container" class="mb-6 hidden"> 
            <div class="border-b border-gray-200">
                <nav id="tab-navigation" class="-mb-px flex space-x-4 sm:space-x-8" aria-label="Tabs">
                    <button id="tab-issuepilot" 
                            class="tab-button inline-flex items-center px-1 py-3 border-b-2 font-medium text-sm transition-colors duration-150 text-gh-primary border-gh-blue" 
                            data-target="issuepilot-view" aria-current="page">
                        <i data-feather="send" class="w-4 h-4 mr-2"></i>
                        <span>IssuePilot</span>
                    </button>

                    <button id="tab-followpilot" 
                            class="tab-button inline-flex items-center px-1 py-3 border-b-2 font-medium text-sm transition-colors duration-150 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700" 
                            data-target="followpilot-view">
                        <i data-feather="eye" class="w-4 h-4 mr-2"></i>
                        <span>FollowPilot</span>
                    </button>
                </nav>
            </div>
        </div>
        <div id="loading-spinner" class="hidden text-center py-10 text-gh-blue">
            <i data-feather="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
            <p>Loading session...</p>
        </div>

        <div id="main-content-area" class="mt-6">
            
            <div id="issuepilot-view" data-tab-content>
                <p class="text-gray-500 mt-2 text-lg mb-4">Create GitHub Issues instantly using the API.</p>
                
                <div id="issues-list-view" class="hidden space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gh-primary">Your IssuePilot History</h2>
                        <button id="new-issue-button"
                                class="flex items-center space-x-2 px-3 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                            <i data-feather="plus" class="w-5 h-5"></i>
                            <span>Create New Issue</span>
                        </button>
                    </div>
                    
                    <div id="issues-loading" class="text-center py-6 hidden">
                        <i data-feather="loader" class="w-6 h-6 animate-spin mx-auto text-gray-500"></i>
                        <p class="text-gray-500 mt-2">Loading issues created by IssuePilot...</p>
                    </div>
                    
                    <div id="issues-empty" class="text-center py-6 hidden">
                        <p class="text-gray-500 italic">No issues found created by IssuePilot.</p>
                    </div>
                    
                    <div id="issues-container" class="space-y-3">
                    </div>
                </div>

                <form id="issue-form" class="space-y-6 hidden">
                    
                    <div id="repo-input-group">
                        <label for="repo-input" class="block text-sm font-medium text-gh-primary mb-1">Repository (Owner/Name) <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="repo-input" placeholder="e.g., supabase/supabase" required
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"
                                   aria-describedby="repo-help">
                            <i data-feather="code" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            
                            <div id="repo-suggestions-container" class="absolute z-10 w-full mt-1 max-h-60 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                            </div>
                        </div>
                        <p id="repo-help" class="mt-1 text-xs text-gray-500">Format: <code>owner/repository-name</code> (must be a repo you have access to)</p>
                    </div>

                    <div>
                        <label for="title-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Title <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="title-input" placeholder="A concise summary of the bug or feature" required
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                            <i data-feather="tag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <div>
                        <label for="body-input" class="block text-sm font-medium text-gh-primary mb-1">Issue Body / Description</label>
                        <div class="relative">
                            <textarea id="body-input" rows="8" placeholder="Provide context, steps to reproduce, or detailed specifications. (Markdown is supported)"
                                      class="w-full p-3 pl-3 pr-3 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"></textarea>

                            </div>
                        <p class="mt-2 text-xs text-gray-500">Use <code>@username</code> to mention people in the issue.</p>
                    </div>
                    
                    

                    <div>
                        <label for="labels-input" class="block text-sm font-medium text-gh-primary mb-1">Labels (e.g., bug, enhancement, priority:high)</label>
                        <div class="relative">
                            <input type="text" id="labels-input" placeholder="Comma-separated list of existing labels"
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                            <i data-feather="tag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <div>
                        <label for="assignees-input" class="block text-sm font-medium text-gh-primary mb-1">Assignees (GitHub Usernames)</label>
                        <div class="relative">
                            <input type="text" id="assignees-input" placeholder="Comma-separated list of usernames"
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                            <i data-feather="user-plus" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <div>
                        <label for="milestone-input" class="block text-sm font-medium text-gh-primary mb-1">Milestone (Number ID)</label>
                        <div class="relative">
                            <input type="number" id="milestone-input" placeholder="e.g., 1 (Must be the milestone's ID number)"
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150">
                            <i data-feather="flag" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Enter the numeric ID of an existing milestone in the repository.</p>
                    </div>

                    <button type="submit" id="submit-button"
                            class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 ease-in-out transform hover:scale-[1.005]">
                        <i data-feather="send" class="w-5 h-5"></i>
                        <span>Create Issue via API</span>
                    </button>
                </form>
            </div>
            
            <div id="followpilot-view" data-tab-content class="hidden">
                <div id="follow-auth-required" class="text-center py-10 px-4 space-y-6">
                    <i data-feather="lock" class="w-10 h-10 mx-auto mb-4 text-red-500"></i>
                    <h3 class="text-xl font-semibold text-gh-primary">Additional Permissions Required</h3>
                    <p class="text-gray-600">To follow and unfollow users, IssuePilot needs the <code>user:follow</code> permission, which is not included in the standard sign-in.</p>
                    <button id="follow-auth-button"
                            class="w-full sm:w-auto flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                        <i data-feather="user-plus" class="w-5 h-5"></i>
                        <span>Grant Follower Permissions</span>
                    </button>
                    <p class="text-xs text-gray-500">You will be redirected to GitHub to grant access.</p>
                </div>
                
                <div id="follow-main-area" class="hidden">
                    <h2 class="text-2xl font-semibold text-gh-primary mb-4">Bulk Follow/Unfollow</h2>
                    
                    <div id="follow-notification-box" class="hidden p-3 mb-4 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

                    <div id="user-input-group">
                        <label for="users-input" class="block text-sm font-medium text-gh-primary mb-1">GitHub Usernames (One per line or comma-separated)</label>
                        <div class="relative">
                            <textarea id="users-input" rows="8" placeholder="e.g., username1, username2,&#10;username3"
                                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-gh-blue focus:border-gh-blue transition duration-150"></textarea>
                                      
                            <div id="mention-suggestions-container-follow" 
                                 class="absolute z-20 w-full bottom-full mb-1 max-h-40 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-lg hidden"
                                 style="bottom: 100%;">
                            </div>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Start typing usernames (min 3 chars) to see autofill suggestions.</p>
                    </div>
                    
                    <div class="mt-6 flex space-x-4">
                        <button id="bulk-follow-button"
                                class="flex-1 flex items-center justify-center space-x-2 px-4 py-3 bg-gh-success text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                            <i data-feather="user-plus" class="w-5 h-5"></i>
                            <span>Bulk Follow</span>
                        </button>
                        <button id="bulk-unfollow-button"
                                class="flex-1 flex items-center justify-center space-x-2 px-4 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                            <i data-feather="user-minus" class="w-5 h-5"></i>
                            <span>Bulk Unfollow</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-8 pt-6 border-t border-gray-100 text-center text-xs text-gray-400">
            <p>Powered by Supabase and the GitHub API. | <a href="/privacy.html" class="hover:text-gh-dark transition duration-150">Privacy Policy</a></p>
        </footer>
    </div>
    
    <video id="pip-video" src="assets/deletetutorial.mp4" style="display: none;" loop></video>
    
    <div id="pip-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full relative">
            <h3 class="text-xl font-bold mb-3 text-gh-dark flex items-center space-x-2 border-b pb-2">
                 <i data-feather="trash-2" class="w-6 h-6 text-red-600"></i>
                 <span>Confirm Account Deletion</span>
            </h3>
            <p class="text-gray-700 mb-4">You are about to revoke this app's access on GitHub and sign out.</p>
            
            <p class="text-gray-600 mb-6 font-semibold">Do you want a video tutorial to guide you through revoking access in Picture-in-Picture mode?</p>
            
            <div class="space-y-3">
                <button id="modal-yes-button" class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg hover:bg-opacity-90 transition">
                    <i data-feather="monitor" class="w-5 h-5"></i>
                    <span>Yes (Recommended, PiP Tutorial)</span>
                </button>
                <button id="modal-no-button" class="w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                    <span>No (Open GitHub Directly)</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="issue-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl relative flex flex-col h-5/6">
            <header class="p-5 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                <div class="flex items-center space-x-3 overflow-hidden">
                    <h3 id="modal-title" class="text-xl font-bold text-gh-primary truncate"></h3>
                    <div id="modal-state" class="px-3 py-1 text-sm font-semibold rounded-full flex items-center space-x-1 flex-shrink-0"></div>
                </div>
                <button id="close-modal-button" class="p-2 rounded-full hover:bg-gray-200 transition duration-150" aria-label="Close modal">
                    <i data-feather="x" class="w-6 h-6 text-gray-500"></i>
                </button>
            </header>

            <div class="modal-body p-5 space-y-6 flex-grow">
                <div id="modal-repo-info" class="text-sm text-gray-500"></div>
                
                <section>
                    <h4 class="text-lg font-semibold text-gh-primary mb-2 flex items-center space-x-2">
                        <i data-feather="align-left" class="w-4 h-4 text-gh-dark"></i>
                        <span>Description</span>
                    </h4>
                    <div id="modal-body-content" class="p-3 bg-gh-bg rounded-lg text-gray-700 whitespace-pre-wrap"></div>
                </section>
                
                <div class="grid sm:grid-cols-2 gap-6">
                    <section>
                        <h4 class="text-lg font-semibold text-gh-primary mb-2 flex items-center space-x-2">
                            <i data-feather="users" class="w-4 h-4 text-gh-dark"></i>
                            <span>Assignees</span>
                        </h4>
                        <div id="modal-assignees" class="flex flex-wrap gap-2">
                            <span class="text-sm text-gray-500 italic">None assigned.</span>
                        </div>
                    </section>

                    <section>
                        <h4 class="text-lg font-semibold text-gh-primary mb-2 flex items-center space-x-2">
                            <i data-feather="layers" class="w-4 h-4 text-gh-dark"></i>
                            <span>Labels</span>
                        </h4>
                        <div id="modal-labels" class="flex flex-wrap gap-2">
                            <span class="text-sm text-gray-500 italic">No labels.</span>
                        </div>
                    </section>
                </div>
                
                <section>
                    <h4 class="text-lg font-semibold text-gh-primary mb-2 flex items-center space-x-2">
                        <i data-feather="message-circle" class="w-4 h-4 text-gh-dark"></i>
                        <span>Comments</span>
                    </h4>
                    <div id="modal-comments" class="space-y-4">
                        <div id="modal-comments-loading" class="text-center py-4 text-gray-500">
                             <i data-feather="loader" class="w-5 h-5 animate-spin inline-block mr-2"></i>
                            <span>Loading comments...</span>
                        </div>
                    </div>
                </section>

            </div>

            <footer class="p-4 border-t border-gray-200 flex justify-end flex-shrink-0">
                <a id="modal-github-link" target="_blank"
                   class="flex items-center space-x-2 px-4 py-2 bg-gh-blue text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
                    <i data-feather="external-link" class="w-5 h-5"></i>
                    <span>View on GitHub</span>
                </a>
            </footer>
        </div>
    </div>

    <script type="module">
        
        const SUPABASE_URL = 'https://syczfzloslkszzpuvcre.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5Y3pmemxvc2xrc3p6cHV2Y3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MTQwMjUsImV4cCI6MjA4MTE5MDAyNX0.vy8urIWxuwuaEYCjfHiWQUyBYKDXdhGiK8X4x_bafrw';
        const APP_SIGNATURE = '';
        const ISSUE_HISTORY_KEY = 'issuepilot_history';
        
        // Define Scopes
        const BASIC_GITHUB_SCOPES = 'public_repo'; // For general profile and public repo read access
        const ISSUE_PILOT_SCOPE = 'write:issue'; // For creating issues
        const FOLLOW_PILOT_SCOPE = 'user:follow'; // For bulk follow/unfollow
        const ISSUE_SCOPES = `${BASIC_GITHUB_SCOPES}, ${ISSUE_PILOT_SCOPE}`; // Initial sign-in scope
        const ALL_SCOPES = `${ISSUE_SCOPES}, ${FOLLOW_PILOT_SCOPE}`; // FollowPilot sign-in scope

        const form = document.getElementById('issue-form');
        const issuesListView = document.getElementById('issues-list-view');
        const issuesContainer = document.getElementById('issues-container');
        const newIssueButton = document.getElementById('new-issue-button');
        const issuesLoading = document.getElementById('issues-loading');
        const issuesEmpty = document.getElementById('issues-empty');
        const repoInput = document.getElementById('repo-input');
        const repoSuggestionsContainer = document.getElementById('repo-suggestions-container');
        const titleInput = document.getElementById('title-input');
        const bodyInput = document.getElementById('body-input');
        const notificationBox = document.getElementById('notification-box');
        const submitButton = document.getElementById('submit-button');
        const authButton = document.getElementById('auth-button');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authArea = document.getElementById('auth-area');
        const kebabButton = document.getElementById('kebab-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const deleteAccountButton = document.getElementById('delete-account-button');
        const pipVideo = document.getElementById('pip-video');
        const pipModal = document.getElementById('pip-modal');
        const modalYesButton = document.getElementById('modal-yes-button');
        const modalNoButton = document.getElementById('modal-no-button');
        const kebabMenu = document.getElementById('kebab-menu'); 
        const labelsInput = document.getElementById('labels-input');
        const assigneesInput = document.getElementById('assignees-input');
        const milestoneInput = document.getElementById('milestone-input');
        
        const issueModal = document.getElementById('issue-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const modalTitle = document.getElementById('modal-title');
        const modalState = document.getElementById('modal-state');
        const modalRepoInfo = document.getElementById('modal-repo-info');
        const modalBodyContent = document.getElementById('modal-body-content');
        const modalAssignees = document.getElementById('modal-assignees');
        const modalLabels = document.getElementById('modal-labels');
        const modalComments = document.getElementById('modal-comments');
        const modalCommentsLoading = document.getElementById('modal-comments-loading');
        const modalGithubLink = document.getElementById('modal-github-link');
        const helpLink = document.getElementById('help-link');

        // New Tab Variables
        const tabIssuePilot = document.getElementById('tab-issuepilot');
        const tabFollowPilot = document.getElementById('tab-followpilot');
        const issuepilotView = document.getElementById('issuepilot-view');
        const followpilotView = document.getElementById('followpilot-view');
        const tabNavigationContainer = document.getElementById('tab-navigation-container');
        
        // FollowPilot Specific Elements
        const followAuthButton = document.getElementById('follow-auth-button');
        const followAuthRequired = document.getElementById('follow-auth-required');
        const followMainArea = document.getElementById('follow-main-area');
        const usersInput = document.getElementById('users-input');
        const bulkFollowButton = document.getElementById('bulk-follow-button');
        const bulkUnfollowButton = document.getElementById('bulk-unfollow-button');
        const followNotificationBox = document.getElementById('follow-notification-box');
        const mentionSuggestionsContainerFollow = document.getElementById('mention-suggestions-container-follow');


        // Removed: currentMentionQuery, mentionStartIndex

        let currentFollowMentionQuery = '';
        let followMentionStartIndex = -1;

        const GITHUB_REVOKE_URL = 'https://github.com/settings/connections/applications/Ov23lie813N9LAMIwrVR';

        let githubAccessToken = null;
        let githubUsername = null;
        const signInText = 'Connect with GitHub';
        
        let notificationTimeout;

        function showNotification(message, type = 'error', persistent = false) {
            if (!notificationBox) {
                return;
            }

            clearTimeout(notificationTimeout);

            notificationBox.textContent = message;
            notificationBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'success') {
                notificationBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                notificationBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                notificationBox.classList.add('bg-red-100', 'text-red-700');
            }

            if (!persistent) {
                notificationTimeout = setTimeout(() => {
                    notificationBox.classList.add('hidden');
                }, 7000);
            }
        }
        
        function showFollowNotification(message, type = 'error') {
            if (!followNotificationBox) return;

            clearTimeout(notificationTimeout);
            followNotificationBox.textContent = message;
            followNotificationBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'success') {
                followNotificationBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                followNotificationBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                followNotificationBox.classList.add('bg-red-100', 'text-red-700');
            }

            notificationTimeout = setTimeout(() => {
                followNotificationBox.classList.add('hidden');
            }, 10000);
        }


        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function debounce(func, timeout = 400) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function getIssuesFromLocalStorage() {
            try {
                const issuesJson = localStorage.getItem(ISSUE_HISTORY_KEY);
                return issuesJson ? JSON.parse(issuesJson) : [];
            } catch (e) {
                console.error("Could not retrieve issues from localStorage", e);
                return [];
            }
        }

        function saveIssuesToLocalStorage(issues) {
             try {
                localStorage.setItem(ISSUE_HISTORY_KEY, JSON.stringify(issues));
            } catch (e) {
                console.error("Could not save issues to localStorage", e);
            }
        }
        
        function saveIssueToLocalStorage(issueData) {
            const existingIssues = getIssuesFromLocalStorage();
            
            const newIssue = {
                id: `local-${Date.now()}`,
                number: 'pending',
                title: issueData.title,
                state: 'open', 
                created_at: new Date().toISOString(),
                repository_url: `https://api.github.com/repos/${issueData.owner}/${issueData.repo}`,
                url: '#', 
                html_url: '#',
                source: 'local'
            };

            const updatedIssues = [newIssue, ...existingIssues];
            saveIssuesToLocalStorage(updatedIssues);
            
            return newIssue;
        }

        function switchTab(tabId) {
            document.querySelectorAll('[data-tab-content]').forEach(content => {
                content.classList.add('hidden');
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-gh-primary', 'border-gh-blue');
                button.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
                button.removeAttribute('aria-current');
            });

            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }

            const selectedButton = document.querySelector(`.tab-button[data-target="${tabId}"]`);
            if (selectedButton) {
                selectedButton.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
                selectedButton.classList.add('text-gh-primary', 'border-gh-blue');
                selectedButton.setAttribute('aria-current', 'page');
            }
            
            feather.replace();
        }

        function switchView(view) {
            // Ensure we are on the IssuePilot tab before switching forms
            switchTab('issuepilot-view');

            if (view === 'list') {
                issuesListView.classList.remove('hidden');
                form.classList.add('hidden');
            } else if (view === 'form') {
                issuesListView.classList.add('hidden');
                form.classList.remove('hidden');
            }
        }

        function handleSuggestionClick(repoFullName) {
            repoInput.value = repoFullName;
            renderRepoSuggestions([]);
        }

        function displayRepoMessage(message, type = 'info') {
            repoSuggestionsContainer.innerHTML = '';
            
            let icon = 'info';
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-700';

            if (type === 'warning') {
                icon = 'alert-triangle';
                bgColor = 'bg-yellow-50';
                textColor = 'text-yellow-700';
            }

            const messageHtml = `
                <div class="p-3 ${bgColor} ${textColor} text-sm flex items-center rounded-lg">
                    <i data-feather="${icon}" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <span>${message}</span>
                </div>
            `;
            repoSuggestionsContainer.insertAdjacentHTML('beforeend', messageHtml);
            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        function renderRepoSuggestions(repos) {
            repoSuggestionsContainer.innerHTML = '';

            if (!repos || repos.length === 0) {
                repoSuggestionsContainer.classList.add('hidden');
                return;
            }

            repos.forEach(repo => {
                const item = document.createElement('div');
                const repoFullName = repo.full_name;
                
                item.className = 'p-3 cursor-pointer hover:bg-gray-100 transition duration-100 border-b border-gray-100 last:border-b-0 flex items-center justify-between';
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gh-primary">${repoFullName}</span>
                        <span class="text-xs text-gray-500 block">${repo.description ? repo.description.substring(0, 50) + '...' : 'No description'}</span>
                    </div>
                    <i data-feather="star" class="w-4 h-4 text-yellow-500 ml-2"></i>
                `;
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); 
                    handleSuggestionClick(repoFullName);
                });
                repoSuggestionsContainer.appendChild(item);
            });

            repoSuggestionsContainer.classList.remove('hidden');
            feather.replace();
        }

        async function fetchRepoSuggestions(query) {
            if (query.length < 3) return;

            if (!githubAccessToken) {
                displayRepoMessage('Please sign in to search for repositories and improve rate limits.', 'warning');
                return;
            }

            displayRepoMessage('Searching repositories...', 'info');

            const searchQuery = `${query} in:full_name,description`;
            const apiUrl = `https://api.github.com/search/repositories?q=${encodeURIComponent(searchQuery)}&per_page=7`;
            
            try {
                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (githubAccessToken) {
                    headers['Authorization'] = `Bearer ${githubAccessToken}`;
                }
                
                const response = await fetch(apiUrl, { headers });
                const data = await response.json();

                if (response.ok && data.items) {
                    if (data.items.length > 0) {
                        renderRepoSuggestions(data.items);
                    } else {
                        displayRepoMessage(`No results found for "${query}"`, 'info');
                    }
                } else {
                    let errorMessage = data.message || `Failed to fetch repository suggestions. Status: ${response.status}`;
                    if (response.status === 403 && data.message && data.message.includes('rate limit')) {
                         errorMessage = 'Rate limit exceeded for repository search. Please try again soon or sign in.';
                    } else if (response.status === 401) {
                        errorMessage = 'Authentication failed for repository search. Please sign in again.';
                    }
                    showNotification(errorMessage, 'warning');
                    renderRepoSuggestions(null);
                }
            } catch (error) {
                renderRepoSuggestions(null);
            }
        }
        
        const debouncedFetchRepos = debounce((query) => {
            fetchRepoSuggestions(query);
        }, 400);
        
        async function fetchIssueDetails(issueApiUrl) {
            if (!githubAccessToken) {
                 showNotification('Please sign in to view issue details.', 'warning', true);
                 return;
            }
            
            if (issueApiUrl === '#') {
                issueModal.classList.add('hidden');
                showNotification('This is a local copy. Full GitHub details are not available yet. Please wait for the next sync or ensure it was successfully created on GitHub.', 'warning');
                return;
            }

            issueModal.classList.remove('hidden');
            
            modalTitle.textContent = 'Loading Issue...';
            modalState.innerHTML = '';
            modalBodyContent.textContent = '';
            modalAssignees.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin text-gray-400"></i>`;
            modalLabels.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin text-gray-400"></i>`;
            modalComments.innerHTML = `<div id="modal-comments-loading" class="text-center py-4 text-gray-500"><i data-feather="loader" class="w-5 h-5 animate-spin inline-block mr-2"></i><span>Loading comments...</span></div>`;
            feather.replace();


            try {
                const issueResponse = await fetch(issueApiUrl, {
                    headers: { 'Authorization': `Bearer ${githubAccessToken}` }
                });
                
                const commentsResponse = await fetch(`${issueApiUrl}/comments`, {
                    headers: { 'Authorization': `Bearer ${githubAccessToken}` }
                });

                if (issueResponse.ok && commentsResponse.ok) {
                    const issueData = await issueResponse.json();
                    const commentsData = await commentsResponse.json();
                    displayIssueModal(issueData, commentsData);
                } else {
                    showNotification('Failed to fetch issue details. Check repository access or API limits.', 'error');
                    issueModal.classList.add('hidden');
                }

            } catch (error) {
                showNotification('Network error while fetching issue details.', 'error');
                issueModal.classList.add('hidden');
            }
        }

        function displayIssueModal(issue, comments) {
            const isOpen = issue.state === 'open';
            const stateText = isOpen ? 'Open' : 'Closed';
            const stateClass = isOpen ? 'bg-gh-open/20 text-gh-open' : 'bg-gh-closed/20 text-gh-closed';
            const stateIcon = isOpen ? 'circle' : 'check-circle';
            const repoPath = issue.repository_url.split('/').slice(-2).join('/');
            const date = new Date(issue.created_at).toLocaleDateString();

            modalTitle.textContent = `#${issue.number} ${issue.title}`;
            modalState.className = `px-3 py-1 text-sm font-semibold rounded-full flex items-center space-x-1 flex-shrink-0 ${stateClass}`;
            modalState.innerHTML = `<i data-feather="${stateIcon}" class="w-3 h-3"></i><span>${stateText}</span>`;
            modalRepoInfo.innerHTML = `Created on <strong>${date}</strong> in repository <code>${repoPath}</code>`;
            
            const cleanedBody = issue.body.replace(APP_SIGNATURE, '').trim();
            modalBodyContent.textContent = cleanedBody || 'No description provided.';
            
            modalAssignees.innerHTML = '';
            if (issue.assignees && issue.assignees.length > 0) {
                issue.assignees.forEach(assignee => {
                    modalAssignees.innerHTML += `
                        <a href="${assignee.html_url}" target="_blank" class="flex items-center space-x-1 text-xs px-2 py-1 bg-gray-200 rounded-full hover:bg-gray-300 transition">
                            <img src="${assignee.avatar_url}" class="w-4 h-4 rounded-full" alt="${assignee.login}">
                            <span>@${assignee.login}</span>
                        </a>
                    `;
                });
            } else {
                modalAssignees.innerHTML = `<span class="text-sm text-gray-500 italic">None assigned.</span>`;
            }

            modalLabels.innerHTML = '';
            if (issue.labels && issue.labels.length > 0) {
                issue.labels.forEach(label => {
                    const labelColor = label.color ? `#${label.color}` : '#fef2c0';
                    const textColor = (parseInt(label.color, 16) > 0xffffff / 2) ? '#000000' : '#ffffff';
                    modalLabels.innerHTML += `
                        <span style="background-color: ${labelColor}; color: ${textColor};" class="text-xs font-semibold px-2 py-0.5 rounded-full inline-block" title="${label.description || label.name}">
                            ${label.name}
                        </span>
                    `;
                });
            } else {
                modalLabels.innerHTML = `<span class="text-sm text-gray-500 italic">No labels.</span>`;
            }
            
            modalComments.innerHTML = '';
            if (comments && comments.length > 0) {
                comments.forEach(comment => {
                    modalComments.innerHTML += `
                        <div class="border p-3 rounded-lg bg-white">
                            <div class="flex items-center space-x-2 mb-2 border-b pb-2">
                                <img src="${comment.user.avatar_url}" class="w-6 h-6 rounded-full" alt="${comment.user.login}">
                                <span class="font-semibold text-gh-dark">@${comment.user.login}</span>
                                <span class="text-xs text-gray-500">commented on ${new Date(comment.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">${comment.body || 'No comment body.'}</p>
                        </div>
                    `;
                });
            } else {
                 modalComments.innerHTML = `<p class="text-center py-4 text-gray-500 italic">No comments on this issue yet.</p>`;
            }

            modalGithubLink.href = issue.html_url;

            feather.replace();
            issueModal.classList.remove('hidden');
        }

        function renderIssues(issues) {
            issuesContainer.innerHTML = '';
            issuesLoading.classList.add('hidden');
            issuesEmpty.classList.add('hidden');

            if (!issues || issues.length === 0) {
                issuesEmpty.classList.remove('hidden');
                return;
            }

            issues.forEach(issue => {
                const isOpen = issue.state === 'open';
                const stateColor = isOpen ? 'text-gh-open' : 'text-gh-closed';
                const stateBg = isOpen ? 'bg-gh-open/10' : 'bg-gh-closed/10';
                const stateIcon = isOpen ? 'circle' : 'check-circle';
                const repoPath = issue.repository_url.split('/').slice(-2).join('/');
                const date = new Date(issue.created_at).toLocaleDateString();
                const isLocal = issue.source === 'local';

                const issueCard = document.createElement('div');
                issueCard.className = 'issue-card block';
                issueCard.setAttribute('data-issue-url', issue.url);
                
                let localTag = '';
                if (isLocal) {
                    localTag = `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700 flex items-center ml-2" title="Issue successfully created but not yet fetched from GitHub API. This is a local copy.">
                                <i data-feather="hard-drive" class="w-3 h-3 mr-1"></i>Local Copy
                            </span>`;
                }

                issueCard.innerHTML = `
                    <div class="flex-shrink-0 mr-4 mt-1">
                        <i data-feather="${stateIcon}" class="w-4 h-4 ${stateColor}"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-baseline justify-between mb-1">
                            <span class="font-mono text-xs text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">${repoPath}</span>
                            <div class="flex items-center">
                                ${localTag}
                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${stateBg} ${stateColor} flex items-center ml-2">
                                    <i data-feather="${stateIcon}" class="w-3 h-3 mr-1"></i>
                                    ${isOpen ? 'Open' : 'Closed'}
                                </span>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gh-primary transition-colors duration-150">${issue.title}</h3>
                        <p class="text-sm text-gray-500 mt-1">#${issue.number} created on ${date}</p>
                    </div>
                `;
                
                issueCard.addEventListener('click', () => fetchIssueDetails(issue.url));
                issuesContainer.appendChild(issueCard);
            });
            feather.replace();
        }


        async function fetchUserIssues(username) {
            if (!username || !githubAccessToken) {
                renderIssues(getIssuesFromLocalStorage());
                return;
            }

            issuesContainer.innerHTML = '';
            issuesEmpty.classList.add('hidden');
            issuesLoading.classList.remove('hidden');
            feather.replace();

            const query = `author:${username} is:issue state:all in:body "${APP_SIGNATURE}"`; 
            const apiUrl = `https://api.github.com/search/issues?q=${encodeURIComponent(query)}&sort=updated&order=desc`;
            
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const githubIssues = data.items.map(issue => ({ ...issue, source: 'github' }));
                    
                    const localIssues = getIssuesFromLocalStorage();
                    
                    const combinedIssues = [...githubIssues];
                    
                    localIssues.forEach(localIssue => {
                        if (!githubIssues.some(ghIssue => ghIssue.title === localIssue.title && ghIssue.repository_url === localIssue.repository_url)) {
                            combinedIssues.push(localIssue);
                        }
                    });
                    
                    combinedIssues.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    saveIssuesToLocalStorage(githubIssues);
                    renderIssues(combinedIssues);
                } else {
                    const errorData = await response.json();
                    showNotification(`Failed to fetch issues: ${errorData.message || response.statusText}. Showing local history.`, 'error');
                    renderIssues(getIssuesFromLocalStorage()); 
                }
            } catch (error) {
                showNotification('Network error while fetching issues. Showing local history.', 'error');
                renderIssues(getIssuesFromLocalStorage());
            } finally {
                issuesLoading.classList.add('hidden');
            }
        }
        
        async function signInWithGitHub(scopes = ISSUE_SCOPES) {
            // Save current tab state before redirect
            localStorage.setItem('issuepilot_current_tab', document.querySelector('.tab-button[aria-current="page"]')?.dataset.target || 'issuepilot-view');
            
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    scopes: scopes, 
                }
            });

            if (error) {
                showNotification(`Sign In Failed: ${error.message}`, 'error');
            }
        }
        
        async function signInWithFollowScope() {
            // This is called from the FollowPilot tab to upgrade permissions
            localStorage.setItem('issuepilot_follow_granted', 'true');
            await signInWithGitHub(ALL_SCOPES);
        }

        function updateUI(session) {
            loadingSpinner.classList.add('hidden');

            const isSignedOut = !session || !session.provider_token;
            let isFollowPilotAuth = !isSignedOut && localStorage.getItem('issuepilot_follow_granted') === 'true';


            if (!isSignedOut) {
                githubAccessToken = session.provider_token;
                
                const user = session.user;
                const userMetadata = user.user_metadata || {};
                githubUsername = userMetadata.user_name;

                authArea.classList.remove('justify-center', 'flex-col', 'space-y-3');
                authArea.classList.add('justify-between', 'flex-row');

                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                
                helpLink.classList.add('hidden');

                userName.textContent = githubUsername || user.email || 'GitHub User';
                userAvatar.src = userMetadata.avatar_url || 'https://placehold.co/32x32/cccccc/333333?text=U';
                
                authButton.innerHTML = `<i data-feather="log-out" class="w-5 h-5"></i><span id="auth-button-text">Sign Out</span>`;
                authButton.classList.remove('bg-gh-blue');
                authButton.classList.add('bg-red-500'); 
                
                kebabButton.classList.remove('hidden');
                tabNavigationContainer.classList.remove('hidden'); // SHOW TABS

                showNotification(`Logged in as ${userName.textContent}. Loading your data...`, 'success');
                
                // FollowPilot View Logic
                if (isFollowPilotAuth) {
                    followAuthRequired.classList.add('hidden');
                    followMainArea.classList.remove('hidden');
                } else {
                    followAuthRequired.classList.remove('hidden');
                    followMainArea.classList.add('hidden');
                }


                // Restore previous tab or default to issuepilot
                const lastTab = localStorage.getItem('issuepilot_current_tab') || 'issuepilot-view';
                switchTab(lastTab);
                
                if (lastTab === 'issuepilot-view') {
                     switchView('list');
                     fetchUserIssues(githubUsername);
                }

            } else {
                // Logged Out State
                githubAccessToken = null;
                githubUsername = null;
                
                localStorage.removeItem('issuepilot_follow_granted'); // Clear follow permission flag

                authArea.classList.remove('justify-between', 'flex-row');
                authArea.classList.add('justify-center', 'flex-col', 'space-y-3');

                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
                issuesListView.classList.add('hidden');
                form.classList.add('hidden');
                
                tabNavigationContainer.classList.add('hidden'); // HIDE TABS
                
                helpLink.classList.remove('hidden');
                
                authButton.innerHTML = `<i data-feather="github" class="w-5 h-5"></i><span id="auth-button-text">${signInText}</span>`;
                authButton.classList.remove('bg-red-500');
                authButton.classList.add('bg-gh-blue');
                
                dropdownMenu.classList.add('hidden');
                
                showNotification('Please sign in with GitHub to create issues via the API.', 'warning', true);

                // Default to IssuePilot tab view (even though hidden)
                switchTab('issuepilot-view');
            }
            feather.replace();
        }

        async function signOut() {
            dropdownMenu.classList.add('hidden');

            const { error } = await supabase.auth.signOut();
            if (error) {
                showNotification(`Sign Out Failed: ${error.message}`, 'error');
            } else {
                updateUI(null);
            }
        }
        
        function handleDeleteAccount() {
            dropdownMenu.classList.add('hidden');
            pipModal.classList.remove('hidden');
        }

        async function handleModalYes() {
            pipModal.classList.add('hidden');

            if ('pictureInPictureEnabled' in document && pipVideo) {
                try {
                    pipVideo.muted = true;
                    await pipVideo.play(); 
                    await pipVideo.requestPictureInPicture();
                    showNotification('Video tutorial requested. Please grant Picture-in-Picture permission (near address bar).', 'warning');

                    setTimeout(async () => {
                        window.open(GITHUB_REVOKE_URL, '_blank');
                        showNotification('GitHub settings opened in new tab. Follow the video guide.', 'warning');
                        await signOut();
                    }, 1000); 

                } catch (error) {
                    console.error('PiP failed or video playback was blocked:', error);
                    showNotification('Could not start Picture-in-Picture. Opening GitHub settings directly.', 'warning');
                    handleModalNo();
                }
            } else {
                showNotification('Your browser does not support Picture-in-Picture. Opening GitHub settings directly.', 'warning');
                handleModalNo();
            }
        }

        async function handleModalNo() {
            pipModal.classList.add('hidden');
            window.open(GITHUB_REVOKE_URL, '_blank');
            showNotification('GitHub settings opened in new tab. Please manually revoke access.', 'warning');
            await signOut();
        }

        // Removed: insertAtCursor

        // Removed: hideMentionDropdown, checkMentionTrigger, fetchUserSuggestions, debouncedFetchUsers, handleMentionSelection, renderUserSuggestions


        async function createIssue(event) {
            event.preventDefault();
            
            if (!githubAccessToken || !githubUsername) {
                showNotification('You must be signed in to create an issue.', 'error', true);
                return;
            }

            const repoValue = repoInput.value.trim();
            const titleValue = titleInput.value.trim();
            let bodyValue = bodyInput.value.trim();
            
            const labelsValue = labelsInput.value.trim();
            const assigneesValue = assigneesInput.value.trim();
            const milestoneValue = milestoneInput.value.trim();
            
            if (!repoValue || !titleValue || !repoValue.includes('/')) {
                showNotification('Please fill in the repository (owner/name) and title correctly.', 'error');
                return;
            }

            const [owner, repo] = repoValue.split('/');

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Creating Issue...</span>`;
            feather.replace();
            
            saveIssueToLocalStorage({ owner, repo, title: titleValue });

            bodyValue = bodyValue + '\n\n' + APP_SIGNATURE;

            const issueData = {
                title: titleValue,
                body: bodyValue,
            };
            
            if (labelsValue) {
                issueData.labels = labelsValue.split(',').map(label => label.trim()).filter(label => label.length > 0);
            }
            
            if (assigneesValue) {
                issueData.assignees = assigneesValue.split(',').map(assignee => assignee.trim()).filter(assignee => assignee.length > 0);
            }

            if (milestoneValue) {
                const milestoneNumber = parseInt(milestoneValue, 10);
                if (!isNaN(milestoneNumber) && milestoneNumber > 0) {
                    issueData.milestone = milestoneNumber;
                } else {
                     showNotification('Milestone ID must be a positive number. Skipping Milestone field.', 'warning');
                }
            }

            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/issues`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(issueData)
                });

                const data = await response.json();

                if (response.ok) {
                    const issueUrl = data.html_url;
                    let copied = false;
                    
                    const tempInput = document.createElement('input');
                    tempInput.value = issueUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        copied = document.execCommand('copy');
                    } catch (err) {
                        console.error('Could not copy text: ', err);
                    }
                    document.body.removeChild(tempInput);

                    let notificationMessage = `Issue #${data.number} created successfully in ${repoValue}! Now showing history.`;
                    if (copied) {
                        notificationMessage = `Issue #${data.number} created successfully in ${repoValue}! URL copied to clipboard.`;
                    }

                    showNotification(notificationMessage, 'success');
                    
                    titleInput.value = '';
                    bodyInput.value = '';
                    labelsInput.value = '';
                    assigneesInput.value = '';
                    milestoneInput.value = '';
                    
                    switchView('list');
                    fetchUserIssues(githubUsername);
                    
                } else {
                    let errorMessage = data.message || `Failed to create issue. Status: ${response.status}`;
                    if (data.documentation_url) {
                        errorMessage += ` Check logs for details.`;
                    }
                    showNotification(errorMessage, 'error');
                }

            } catch (error) {
                showNotification('A network error occurred while trying to reach GitHub.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i data-feather="send" class="w-5 h-5"></i><span>Create Issue via API</span>`;
                feather.replace();
            }
        }
        
        // --- FollowPilot Logic ---
        
        function getFollowUsersList() {
            const rawText = usersInput.value.trim();
            // Split by comma, newline, or mixed, then trim and filter empty strings
            return rawText.split(/[\s,]+/) 
                          .map(user => user.trim())
                          .filter(user => user.length > 0);
        }

        async function bulkFollowUnfollow(action) {
            if (!githubAccessToken || localStorage.getItem('issuepilot_follow_granted') !== 'true') {
                showFollowNotification('Please grant "Follower Permissions" first.', 'error');
                return;
            }

            const users = getFollowUsersList();
            if (users.length === 0) {
                showFollowNotification('Please enter at least one username.', 'warning');
                return;
            }

            const isFollow = action === 'follow';
            const method = isFollow ? 'PUT' : 'DELETE';
            const successCount = { success: 0, failure: 0, skipped: 0 };
            
            bulkFollowButton.disabled = true;
            bulkUnfollowButton.disabled = true;
            const originalFollowHtml = bulkFollowButton.innerHTML;
            const originalUnfollowHtml = bulkUnfollowButton.innerHTML;

            // Clear previous notification
            followNotificationBox.classList.add('hidden');

            const updateProgress = () => {
                if (isFollow) {
                    bulkFollowButton.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Following (${successCount.success}/${users.length})...</span>`;
                } else {
                    bulkUnfollowButton.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Unfollowing (${successCount.success}/${users.length})...</span>`;
                }
                feather.replace();
            }

            updateProgress();

            for (const username of users) {
                if (username.toLowerCase() === githubUsername.toLowerCase()) {
                    successCount.skipped++;
                    continue;
                }

                const apiUrl = `https://api.github.com/user/following/${username}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${githubAccessToken}`,
                            'Content-Length': 0, // PUT/DELETE often requires Content-Length: 0
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 204) { // 204 No Content is success for follow/unfollow
                        successCount.success++;
                    } else if (response.status === 404) {
                        successCount.failure++;
                        // showFollowNotification(`User @${username} not found on GitHub.`, 'warning');
                    } else {
                        successCount.failure++;
                        // const errorData = await response.json().catch(() => ({ message: response.statusText }));
                        // showFollowNotification(`Failed to ${action} @${username}: ${errorData.message}`, 'error');
                    }

                } catch (error) {
                    successCount.failure++;
                    // showFollowNotification(`Network error attempting to ${action} @${username}.`, 'error');
                }
                
                updateProgress();
            }
            
            // Final UI update
            bulkFollowButton.disabled = false;
            bulkUnfollowButton.disabled = false;
            bulkFollowButton.innerHTML = originalFollowHtml;
            bulkUnfollowButton.innerHTML = originalUnfollowHtml;
            feather.replace();

            let finalMessage = `Bulk ${isFollow ? 'Follow' : 'Unfollow'} complete: ${successCount.success} successful, ${successCount.failure} failed, ${successCount.skipped} skipped.`;
            showFollowNotification(finalMessage, successCount.failure > 0 ? 'warning' : 'success');
        }

        // --- FollowPilot Autofill Logic ---
        
        function hideFollowMentionDropdown() {
            mentionSuggestionsContainerFollow.classList.add('hidden');
            currentFollowMentionQuery = '';
            followMentionStartIndex = -1;
        }

        function checkFollowMentionTrigger() {
            const textarea = usersInput;
            const value = textarea.value;
            const caretPos = textarea.selectionStart;

            // Find the start of the current word/token near the caret position
            const tokenRegex = /([\w-]+)$/; // Capture username part, including hyphens
            const textBeforeCaret = value.substring(0, caretPos);
            
            const match = textBeforeCaret.match(tokenRegex);
            
            if (match) {
                const query = match[1];
                const start = match.index;
                
                if (query.length >= 3) {
                    currentFollowMentionQuery = query;
                    followMentionStartIndex = start;
                    debouncedFetchFollowUsers(query);
                    return;
                }
            }

            hideFollowMentionDropdown();
        }

        async function fetchFollowUserSuggestions(query) {
            if (!githubAccessToken) {
                hideFollowMentionDropdown();
                return;
            }
            
            const apiUrl = `https://api.github.com/search/users?q=${encodeURIComponent(query)} in:login&per_page=5`;
            
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${githubAccessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderFollowUserSuggestions(data.items);
                } else {
                    hideFollowMentionDropdown();
                }
            } catch (error) {
                hideFollowMentionDropdown();
            }
        }
                
        const debouncedFetchFollowUsers = debounce(fetchFollowUserSuggestions, 300);

        function handleFollowMentionSelection(username) {
            const textarea = usersInput;
            const value = textarea.value;
            
            const textBeforeMention = value.substring(0, followMentionStartIndex);
            const textAfterMention = value.substring(textarea.selectionEnd);
            
            const newText = textBeforeMention + username + textAfterMention;
            
            textarea.value = newText;
            
            const newCaretPos = followMentionStartIndex + username.length;
            textarea.selectionStart = newCaretPos;
            textarea.selectionEnd = newCaretPos;

            hideFollowMentionDropdown();
        }

        function renderFollowUserSuggestions(users) {
            mentionSuggestionsContainerFollow.innerHTML = '';
            
            // Re-calculate the dropdown position relative to the textarea's scroll
            const textareaRect = usersInput.getBoundingClientRect();
            const containerRect = mentionSuggestionsContainerFollow.parentElement.getBoundingClientRect();
            
            // Set position using container's relative space and textarea's content position
            // Set bottom to the height of the textarea minus the current scroll position, plus a little buffer
            const scrollBottom = usersInput.scrollHeight - usersInput.scrollTop;
            // This calculation is tricky in a general sense, simple bottom positioning works best for single-line.
            // For multiline, we'll try to keep it at the bottom of the container.

            if (!users || users.length === 0) {
                hideFollowMentionDropdown();
                return;
            }
            
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'p-2 cursor-pointer hover:bg-gh-blue/10 text-gh-dark transition duration-100 flex items-center space-x-2 border-b border-gray-100 last:border-b-0';
                item.innerHTML = `
                    <img src="${user.avatar_url}" class="w-6 h-6 rounded-full" alt="${user.login}" onerror="this.onerror=null;this.src='https://placehold.co/24x24/cccccc/333333?text=U'">
                    <span class="font-medium text-sm">@${user.login}</span>
                `;
                
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault(); 
                    handleFollowMentionSelection(user.login);
                });
                mentionSuggestionsContainerFollow.appendChild(item);
            });

            mentionSuggestionsContainerFollow.classList.remove('hidden');
        }



        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            loadingSpinner.classList.remove('hidden');

            authButton.addEventListener('click', () => {
                if (githubAccessToken) {
                    signOut();
                } else {
                    signInWithGitHub();
                }
            });

            kebabButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });
            
            deleteAccountButton.addEventListener('click', handleDeleteAccount);
            modalYesButton.addEventListener('click', handleModalYes);
            modalNoButton.addEventListener('click', handleModalNo);
            
            closeModalButton.addEventListener('click', () => {
                issueModal.classList.add('hidden');
            });
            
            issueModal.addEventListener('click', (e) => {
                if (e.target === issueModal) {
                    issueModal.classList.add('hidden');
                }
            });

            // Removed: mentionButton, bodyInput mention event listeners
            
            document.addEventListener('click', (e) => {
                if (kebabMenu && !kebabMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });

            newIssueButton.addEventListener('click', () => {
                switchView('form');
            });

            form.addEventListener('submit', createIssue);
            
            repoInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query.length === 0) {
                    renderRepoSuggestions([]);
                } else if (query.length < 3) {
                    displayRepoMessage('Start typing more characters (at least 3) to search.', 'warning');
                } else {
                    debouncedFetchRepos(query);
                }
            });

            repoInput.addEventListener('blur', () => {
                setTimeout(() => {
                    repoSuggestionsContainer.classList.add('hidden');
                }, 200);
            });

            repoInput.addEventListener('focus', (e) => {
                if (repoSuggestionsContainer.children.length > 0 && e.target.value.trim().length >= 3 && repoSuggestionsContainer.children[0].classList.contains('p-3')) {
                    repoSuggestionsContainer.classList.remove('hidden');
                }
            });

            // Tab Event Listeners
            tabIssuePilot.addEventListener('click', () => {
                switchTab('issuepilot-view');
                if (githubAccessToken) {
                    // Force refresh view to list
                    switchView('list'); 
                    fetchUserIssues(githubUsername); 
                }
            });

            tabFollowPilot.addEventListener('click', () => {
                switchTab('followpilot-view');
                // No need to run an API call here, logic is in updateUI on sign-in, or in auth buttons
            });
            
            // FollowPilot Specific Event Listeners
            followAuthButton.addEventListener('click', signInWithFollowScope);
            bulkFollowButton.addEventListener('click', () => bulkFollowUnfollow('follow'));
            bulkUnfollowButton.addEventListener('click', () => bulkFollowUnfollow('unfollow'));
            
            usersInput.addEventListener('input', checkFollowMentionTrigger);
            usersInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideFollowMentionDropdown();
                }
            });
            usersInput.addEventListener('blur', () => {
                setTimeout(hideFollowMentionDropdown, 100); 
            });


            supabase.auth.getSession().then(({ data: { session } }) => {
                updateUI(session);
            });

            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                    updateUI(session);
                } else if (event === 'SIGNED_OUT') {
                    updateUI(null);
                }
            });
        });
    </script>
</body>
</html>
